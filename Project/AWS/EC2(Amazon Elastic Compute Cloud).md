
# EC2란
#### AWS Cloud에서 필요한 만큼의 가상 서버(인스턴스)를 손쉽게 생성, 관리할 수 있게 해주는 서비스
- 가상 서버
	물리 서버의 한계점을 보완하기 위해 설계
	- OS가 하드웨어와 같은 계층으로 존재하여 이식이 불가능함
	- 서버 문제시 리소스 활용 불가능
	- 높은 비용, 확장성 제약, 배포 시간이 김
- 온디맨드 확장 가능성
- 고가용성 & 내결함성

# AWS EC2 생성하기

#### 인스턴스 생성
- Amazon Linux > AMI 설정(프리 티어 사용 가능) : AMI를 통해 인스턴스(VM)의 OS를 설정
- 인스턴스 유형 > t2.micro 선택 : OS의 version 선택
- 키 페어 > 키 페어 생성(이름은 루트 계정 별칭+지역) : 이미 생성된 키 페어를 사용해도 됨
- 네트워크 설정 > 편집 > 방화벽(보안 그룹)
- Window도 마찬가지로 생성 (AMI Microsoft 설정, 보안 그룹 WebAccessAuth로 변경)
	
#### 인스턴스 연결
- 리눅스: EC2 인스턴스 연결 > 퍼블릭 IP(35.79.225.188) 사용 연결
- IP 할당 확인 명령어(ifconfig)
- 윈도우: RDP 클라이언트 연결(아이디: Public DNS, 비번: 암호 가져오기)
- 원결 데스크톱 파일 다운로드 > 실행 > 암호 입력
- 액세스 키 만들기 > 액세스 키 / 비밀 액세스 키
	
#### 인스턴스 권한 부여 방식
- 기존 인스턴스를 생성하게 되면 cat credential을 통해 인스턴스의 키 페어등을 쉽게 얻어갈 수 있기에 액세스 키를 부여하거나, 역할 생성을 통해 권한을 부여하는 식으로 하여 접근을 불가능하게 만듦. 
- 액세스 키(리눅스 명령어) : 액세스 키를 통해 접근이 가능하지만, 액세스 키를 저장하고, 숨겨야 하는 번거로움 존재
	- aws s3 ls: 생성된 bucket 출력 명령어
		- s3는 데이터 저장소, 데이터 개수 제한 X
	- pwd: 현재 위치 출력 명령어
	- aws configurt: 권한 부여 명령어
		- 액세스 키 ID / 비밀번호 / 지역 이름(ap-northeast-1)
	- aws s3 mb s3://유일한 bucket이름: bucket 생성 명령어
	- cat config / cat credentials : 이 명령어들은 각각 지역 이름, 액세스 키 ID, 비밀번호와 같은 민감한 보안 정보를 노출 시켜 보안에 취약점을 만들 수 있음
		- rm -rf ~/.aws/*: 위 정보를 삭제하는 명령어
		- 액세스 키 비활성화 or 삭제
	
- 역할 생성 : IAM에서 사용자에게 권한을 부여하여 AWS 접근권한을 부여하는 방식과 동일하게 EC2에 접근권한을 생성하여 해당 역할을 부여하게 되면 해당 인스턴스를 통해 사용가능한 AWS가 제한적이게 됨.
	- 보안 상 역할 생성 후 부여해주는 방식이 안전함
	- AmazonS3ReadOnlyAccess: s3는 데이터 접근만 가능해도 충분(보안 상 선택)
	- EC2 > 인스턴스 > 작업 > 보안 > IAM 역할 수정
	- 계정에 역할을 부여하는 것이 아닌 AWS 서비스로 IAM 역할을 부여하는 것 (알아서 분류 해줌)

# EC2 handling

#### 확장 가능성
- auto scaling
- amazon cloud Watch -> auto Scaling Group
1. 사용가능성 유지(현재 시스템 유지) -> fail된 VM instance를 대체하여 생성
2. 확장(scale-up) -> 트래픽 증가 등의 원인으로 VM instance의 리소스 사용량이 증가 시 추가 생성
가용영역 내 subnet은 복제x, 단일

- ELB(Elastic Load Balancing) : 사용자가 서버에 접속을 하다가 위 과정처럼 instance가 fail이 날 경우 사용자가 접속하고 있는 instance를 다른 instance로 옮겨줌(latency x)
	- 대상 등록에서 동적으로 하기 위해 선택x

automatic-scaling(scale-up) : cloudwatch | intance 개수로 확인

# 두 인스턴스의 volume 공유

#### Volume
- 인스턴스의 데이터를 저장하는 device로 인스턴스 생성시 시스템의 데이터를 저장하는 root volume(system device)가 자동으로 생성됨.
- 새로 생성하여 인스턴스에 붙이면, usb처럼 디바이스가 attach되고, mount를 통해 device내부에 접근이 가능해진다.

#### Snapshot
- 스냅샷은 특정 분기의 볼륨의 상태를 저장한 것으로, 내가 볼륨의 스냅샷을 찍게되는 시간을 기점으로 volume내 데이터가 저장됨
- 스냅샷을 통해 볼륨의 복사본을 얻고, 이를 통해 볼륨을 생성하여 특정 분기의 볼륨을 복사할 수 있다.

위 두 방식을 종합하여 사용하게 되면 
1. 인스턴스에 시스템 볼륨이 아닌 새로운 볼륨을 만들어 붙여준다.
2. 마운트를 통해 볼륨에 접근 권한을 얻고, 안에서 새로운 파일을 생성하거나 edit을 한다.
3. 위 과정이 저장된 볼륨을 스냅샷을 찍어 2번과정이 끝난 볼륨을 저장한다.
4. 해당 스냅샷으로 새로운 볼륨을 생성한다. -> volume copy본 생성
5. 위 copy볼륨을 두 번째 인스턴스에 attach한다.
6. 두 번째 인스턴스에서 mount를 진행한다.
7. cd /data에 ls를 통해 파일이 존재하거나, edit된 내용에 접근하여 스냅샷이 정상적으로 찍혔는지 확인한다.

위 과정을 통해 인스턴스로 볼륨 내 데이터를 만진 내용을 다른 인스턴스에서 접근하여 확인할 수 있는데, 위 과정을 읽기만 해도 매우 비효율 적이라는 것을 확인할 수 있는데, 
1. 실시간 동기화가 불가능 : 첫 번째 인스턴스에서 수정한 내용들을 두 번째 인스턴스에서 실시간으로 확인 불가능
2. 번거로움 : 일일이 스냅샷을 찍고, 볼륨을 생성해서 연결해주는 행위는 비효율 적이다.

따라서 aws에서는 위 단점들을 해결하기 위해 2가지의 대표적인 방식을 제공하는데, 
1. AWS multi-attach : 최대 16개의 인스턴스를 연결 가능
2. Amazon EFS : 파일시스템에 여러 인스턴스가 mount

가 존재한다.

하지만 1번은 동시 쓰기 시에 conflict로 인한 오류가 발생하여 데이터 손실의 위험이 매우 크다.

따라서 Amazon EFS로 여러 인스턴스에서 접근가능 하도록 만들어 준다.

#### Amazon EFS(Elastic File System)

_조건_
1. 두 인스턴스의 보안그룹이 같아야함.(port : 2049(NFS) 인바운드 규칙 포함)
2. 파일시스템의 보안그룹에 두 인스턴스의 동일한 보안그룹 설정

_시작_
1. VPC 호스트 이름 확인하기 -> 비활성화 경우 설정에서 활성화 해주기
2. 두 인스턴스에 EFS 마운트
```
$ sudo mkdir /shared_data  -> 공유할 파일인 shared_data생성
$ sudo yum install -y amazon-efs-utils  -> efs 설정을 위한 세팅
$ sudo mount -t efs "EFS ID":/ /shared_data  -> shared_data에 EFS 마운트
$ echo "hello" | sudo tee /shared_data/test.txt  -> text file에 내용 저장

다른 인스턴스에 위 1~3 진행 후
$ cat /shared_data/test.txt -> file에 저장된 내용 확인
```

위 과정을 통해 txt파일에 저장된 정보를 확인가능
